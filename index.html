<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>R6 Shooter PvP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;overflow:hidden;width:100vw;height:100vh;font-family:sans-serif;background:#000;}
canvas{display:block;width:100%;height:100%;}
#ui button{position:fixed;right:20px;padding:12px 16px;font-size:16px;border:none;border-radius:12px;background:#fff;z-index:10}
#shoot{bottom:20px} #aim{bottom:80px} #view{bottom:140px} #jump{bottom:200px} #shopBtn{top:20px}
#joyBase{position:fixed;left:30px;bottom:30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.15);z-index:10}
#joyStick{position:absolute;left:40px;top:40px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.6);}
#shop{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:20}
.shopItem{padding:10px 20px;margin:10px;border:1px solid white;border-radius:10px;cursor:pointer}
#hud{position:fixed;top:10px;left:10px;color:white;font-weight:bold;z-index:10}
#hud div{margin-bottom:6px;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:8px}
#weaponText{position:fixed;bottom:20px;left:50%;transform:translateX(-50%)}
#moneyPopup{position:fixed;top:60px; left:50%;transform:translateX(-50%);font-size:24px;font-weight:bold;color:#0f0; opacity:0;transition:0.4s; z-index:20;}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;color:red;pointer-events:none;display:none;z-index:15;}
</style>
</head>
<body>

<div id="joyBase"><div id="joyStick"></div></div>

<div id="ui">
  <button id="shopBtn">üõí</button>
  <button id="view">üëÅ</button>
  <button id="aim">üéØ</button>
  <button id="shoot">üî´</button>
  <button id="jump">‚¨ÜÔ∏è</button>
</div>

<div id="shop">
  <h2>Ïπ¥Ïö∞Î≥¥Ïù¥ ÏÉÅÏ†ê</h2>
  <div class="shopItem" onclick="buyWeapon('revolver')">üî´ Revolver ‚Äì Î¨¥Î£å</div>
  <div class="shopItem" onclick="buyWeapon('glock')">üî´ Glock ‚Äì 2000$</div>
  <button onclick="closeShop()">Îã´Í∏∞</button>
</div>

<div id="hud">
  <div id="hpText">‚ù§Ô∏è 100</div>
  <div id="coinText">$0</div>
  <div id="weaponText">üî´ Revolver | 6/6</div>
</div>
<div id="moneyPopup"></div>
<div id="crosshair">‚úñ</div>

<audio id="revolverSound" src="https://cdn.jsdelivr.net/gh/naptha/talkbox/sounds/gunshot.wav"></audio>
<audio id="glockSound" src="https://cdn.jsdelivr.net/gh/naptha/talkbox/sounds/laser.wav"></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
// ===== Ï†ÄÏû• & HUD =====
let skin=localStorage.getItem("skin")||"brown";
let outfit=localStorage.getItem("outfit")||"cowboy";
let money=Number(localStorage.getItem("money"))||0;
let ownedWeapons=JSON.parse(localStorage.getItem("weapons"))||["revolver"];
let hp=100;

// ===== Ï¥ùÍ∏∞ ÏÉÅÌÉú =====
const weaponsData={
  revolver:{name:"Revolver",damage:25,recoil:.15,fireRate:500,sound:"revolver",maxAmmo:6},
  glock:{name:"Glock",damage:15,recoil:.07,fireRate:120,sound:"glock",price:2000,maxAmmo:17},
  bbgun:{name:"BBgun",damage:5,recoil:.02,fireRate:30,sound:"glock",price:100,maxAmmo:50}
};
let currentWeapon="revolver";
let ammo = {revolver:6, glock:17, bbgun:50};
let gun;

// ===== THREE.js Í∏∞Î≥∏ =====
const scene=new THREE.Scene(); scene.background=new THREE.Color(0xcfa46a);
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,300); camera.position.set(0,4,6);
const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(innerWidth,innerHeight); document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff,.7));
const sun=new THREE.DirectionalLight(0xffffff,1); sun.position.set(30,50,20); scene.add(sun);
const ground=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshStandardMaterial({color:0xc2a46d})); ground.rotation.x=-Math.PI/2; scene.add(ground);

// ===== ÌîåÎ†àÏù¥Ïñ¥ R6 =====
const player=new THREE.Group(); scene.add(player);
const skinColor=()=> skin==="black"?0x222222:(skin==="white"?0xffffff:0xffdbac);
const torso=new THREE.Mesh(new THREE.BoxGeometry(2,2.2,1), new THREE.MeshStandardMaterial({color:skinColor()})); torso.position.y=2; player.add(torso);
const head=new THREE.Mesh(new THREE.BoxGeometry(1.1,1.1,1.1), new THREE.MeshStandardMaterial({color:skinColor()})); head.position.y=3.4; player.add(head);
const rightArm=new THREE.Mesh(new THREE.BoxGeometry(0.8,2,0.8), new THREE.MeshStandardMaterial({color:skinColor()})); rightArm.position.set(1.5,2,0); player.add(rightArm);
const leftArm=new THREE.Mesh(new THREE.BoxGeometry(0.8,2,0.8), new THREE.MeshStandardMaterial({color:skinColor()})); leftArm.position.set(-1.5,2,0); player.add(leftArm);
const rightLeg=new THREE.Mesh(new THREE.BoxGeometry(0.8,2,0.8), new THREE.MeshStandardMaterial({color:0x444444})); rightLeg.position.set(0.6,0,0); player.add(rightLeg);
const leftLeg=new THREE.Mesh(new THREE.BoxGeometry(0.8,2,0.8), new THREE.MeshStandardMaterial({color:0x444444})); leftLeg.position.set(-0.6,0,0); player.add(leftLeg);

// ===== ÏñºÍµ¥ =====
const faceCanvas=document.createElement("canvas"); faceCanvas.width=128; faceCanvas.height=128;
const fctx=faceCanvas.getContext("2d"); const faceTex=new THREE.CanvasTexture(faceCanvas);
const face=new THREE.Mesh(new THREE.PlaneGeometry(0.9,0.9), new THREE.MeshBasicMaterial({map:faceTex,transparent:true}));
face.position.z=0.56; head.add(face);
function drawFace(type="normal"){fctx.clearRect(0,0,128,128); fctx.fillStyle="#000";
if(type==="dead"){fctx.strokeStyle="#000"; fctx.lineWidth=6; fctx.beginPath(); fctx.moveTo(35,35); fctx.lineTo(55,55); fctx.moveTo(55,35); fctx.lineTo(35,55); fctx.moveTo(75,35); fctx.lineTo(95,55); fctx.moveTo(95,35); fctx.lineTo(75,55); fctx.stroke();}
else{fctx.fillRect(40,40,12,12); fctx.fillRect(76,40,12,12);}
fctx.lineWidth=6; fctx.beginPath();
if(type==="angry"){fctx.arc(64,85,18,Math.PI,0,true);}
else if(type==="aim"){fctx.moveTo(44,80); fctx.lineTo(84,80);}
else if(type==="dead"){fctx.moveTo(44,88); fctx.lineTo(84,88);}
else{fctx.arc(64,80,18,0,Math.PI);}
fctx.stroke(); faceTex.needsUpdate = true;} drawFace();

// ===== HUD ÏóÖÎç∞Ïù¥Ìä∏ =====
function updateHUD(){document.getElementById("weaponText").innerText=`üî´ ${weaponsData[currentWeapon].name} | ${ammo[currentWeapon]}/${weaponsData[currentWeapon].maxAmmo}`; document.getElementById("coinText").innerText=`$${money}`;}
function showMoneyPopup(amount){const el=document.getElementById("moneyPopup"); if(amount>=0){el.innerText=`+$${amount}`; el.style.color="#0f0";} else{el.innerText=`-$${Math.abs(amount)}`; el.style.color="#f00";} el.style.opacity=1; setTimeout(()=>el.style.opacity=0,800);}

// ===== Î¨¥Í∏∞ ÏÉùÏÑ± =====
function createRevolver(){const g=new THREE.Group(); const cyl=new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,.4,32),new THREE.MeshStandardMaterial({color:0x222222,metalness:.7,roughness:.3})); cyl.rotation.z=Math.PI/2;cyl.position.set(-.15,0,0); g.add(cyl); const barrel=new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,.8,32),new THREE.MeshStandardMaterial({color:0x333333,metalness:.8,roughness:.2})); barrel.rotation.z=Math.PI/2; barrel.position.set(0,0,.4); g.add(barrel); const grip=new THREE.Mesh(new THREE.BoxGeometry(.15,.35,.3),new THREE.MeshStandardMaterial({color:0x552200,metalness:.1,roughness:.8})); grip.position.set(-.3,-.1,0); g.add(grip); g.position.set(0,-1,.8); return g;}
function createGlock(){const g=new THREE.Group(); const slide=new THREE.Mesh(new THREE.BoxGeometry(.9,.2,.3),new THREE.MeshStandardMaterial({color:0x111111,metalness:.7,roughness:.2})); g.add(slide); const grip=new THREE.Mesh(new THREE.BoxGeometry(.25,.5,.25),new THREE.MeshStandardMaterial({color:0x111111,metalness:.2,roughness:.8})); grip.position.set(-.2,-.25,0); g.add(grip); const trigger=new THREE.Mesh(new THREE.BoxGeometry(.05,.15,.05),new THREE.MeshStandardMaterial({color:0x444444,metalness:.8,roughness:.3})); trigger.position.set(-.05,-.05,.15); g.add(trigger); g.position.set(0,-1,.8); return g;}
function createBBgun(){const g=new THREE.Group(); const body=new THREE.Mesh(new THREE.BoxGeometry(1,.2,.2),new THREE.MeshStandardMaterial({color:0x888888,metalness:.7,roughness:.2})); g.add(body); g.position.set(0,-1,.8); return g;}
function equipWeapon(type){if(gun) rightArm.remove(gun); if(type==="glock") gun=createGlock(); else if(type==="bbgun") gun=createBBgun(); else gun=createRevolver(); rightArm.add(gun); currentWeapon=type; updateHUD();}

// ===== ÏÉÅÏ†ê =====
function buyWeapon(type){const w=weaponsData[type]; if(ownedWeapons.includes(type)){equipWeapon(type); closeShop(); return;} if(money<w.price){alert("Îèà Î∂ÄÏ°±!"); return;} money-=w.price; localStorage.setItem("money",money); showMoneyPopup(-w.price); ownedWeapons.push(type); localStorage.setItem("weapons",JSON.stringify(ownedWeapons)); equipWeapon(type); closeShop(); updateHUD();}
function openShop(){document.getElementById("shop").style.display="flex"; if(Math.random()<0.01 && !ownedWeapons.includes("bbgun")){ const bbItem=document.createElement("div"); bbItem.className="shopItem"; bbItem.innerText="üî´ BBgun ‚Äì 100$ ÌíÄÏò§ÌÜ†"; bbItem.onclick=()=>buyWeapon("bbgun"); document.getElementById("shop").appendChild(bbItem);}}
function closeShop(){document.getElementById("shop").style.display="none";}
document.getElementById("shopBtn").onclick=openShop;

// ===== Ï¥ù Î∞úÏÇ¨ =====
const sounds={revolver:document.getElementById("revolverSound"), glock:document.getElementById("glockSound")};
function playWeaponSound(){const s=sounds[weaponsData[currentWeapon].sound]; s.currentTime=0; s.play();}
function shoot(){if(ammo[currentWeapon]<=0){alert("ÌÉÑÏïΩ ÏóÜÏùå!"); return;} ammo[currentWeapon]--; playWeaponSound(); sendShoot(); updateHUD();}
document.getElementById("shoot").onclick=shoot;
function reload(){ammo[currentWeapon]=weaponsData[currentWeapon].maxAmmo; updateHUD();}

// ===== Ï°∞Ïù¥Ïä§Ìã±/Ïπ¥Î©îÎùº =====
let moveX=0, moveZ=0, moveTouch=null, dragTouch=null, joyCenter={x:0,y:0}, dragLast={x:0,y:0};
let thirdPerson=true, aiming=false;
document.getElementById("aim").onclick=()=>{
  aiming=!aiming; document.getElementById("crosshair").style.display=aiming?"block":"none";
  camera.fov=aiming?45:70; camera.updateProjectionMatrix();
  drawFace(aiming?"aim":"normal");
};
document.addEventListener("touchstart", e=>{
  for(const t of e.touches){
    if(t.clientX<innerWidth/2 && moveTouch===null){ moveTouch=t.identifier; joyCenter={x:t.clientX,y:t.clientY}; }
    else if(t.clientX>=innerWidth/2 && dragTouch===null){ dragTouch=t.identifier; dragLast={x:t.clientX,y:t.clientY}; }
  }
});
document.addEventListener("touchmove", e=>{
  for(const t of e.touches){
    if(t.identifier===moveTouch){
      const dx=t.clientX-joyCenter.x, dy=t.clientY-joyCenter.y, dist=Math.min(40,Math.hypot(dx,dy)), angle=Math.atan2(dy,dx);
      moveX=Math.cos(angle)*(dist/40)*0.15; moveZ=Math.sin(angle)*(dist/40)*0.15;
      document.getElementById("joyStick").style.transform=`translate(${dx}px,${dy}px)`;
    }
    if(t.identifier===dragTouch){
      const dx=t.clientX-dragLast.x, dy=t.clientY-dragLast.y;
      camera.rotation.y-=dx*0.005; camera.rotation.x-=dy*0.005;
      camera.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,camera.rotation.x));
      dragLast={x:t.clientX,y:t.clientY};
    }
  }
});
document.addEventListener("touchend", e=>{
  for(const t of e.changedTouches){
    if(t.identifier===moveTouch){ moveTouch=null; moveX=0; moveZ=0; document.getElementById("joyStick").style.transform="translate(0px,0px)";}
    if(t.identifier===dragTouch){ dragTouch=null; }
  }
});

// ===== WebSocket Î©ÄÌã∞ÌîåÎ†àÏù¥ =====
const ws=new WebSocket("ws://ÏÑúÎ≤ÑIP:8080");
let playerID=null, otherPlayers={};
ws.onmessage=e=>{
  const msg=JSON.parse(e.data);
  if(msg.type==="init") playerID=msg.id;
  if(msg.type==="update"){ 
    if(!otherPlayers[msg.id]){ const p=new THREE.Group(); const torso=new THREE.Mesh(new THREE.BoxGeometry(2,2.2,1),new THREE.MeshStandardMaterial({color:0x888888})); p.add(torso); scene.add(p); otherPlayers[msg.id]=p;}
    const op=otherPlayers[msg.id]; op.position.set(msg.x,msg.y,msg.z); op.rotation.y=msg.rotY;
  }
  if(msg.type==="shoot"){ console.log(`${msg.id} fired ${msg.weapon}`);}
};
function sendUpdate(){if(!playerID) return; ws.send(JSON.stringify({type:"update",id:playerID,x:player.position.x,y:player.position.y,z:player.position.z,rotY:player.rotation.y}));}
function sendShoot(){if(!playerID) return; ws.send(JSON.stringify({type:"shoot",id:playerID,weapon:currentWeapon}));}

// ===== Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ =====
function animate(){requestAnimationFrame(animate);
  player.position.x+=moveX; player.position.z+=moveZ;
  camera.position.x=player.position.x; camera.position.y=player.position.y+3; camera.position.z=player.position.z+(thirdPerson?6:0);
  camera.lookAt(player.position.x,player.position.y+2,player.position.z);
  sendUpdate(); renderer.render(scene,camera);
}
equipWeapon("revolver"); animate(); updateHUD();
</script>

</body>
</html>