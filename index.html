<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>FPS STEP2</title>
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0; padding:0;
  overflow:hidden;
  background:black;
  touch-action:none;
}

/* 조준 X */
#crosshair{
  position:fixed;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  font-size:24px;
  color:white;
  pointer-events:none;
}

/* 피격 이펙트 */
#hit{
  position:fixed;
  inset:0;
  background:red;
  opacity:0;
  pointer-events:none;
  transition:.1s;
}

/* 돈 표시 */
#money{
  position:fixed;
  top:10px; left:10px;
  color:#0f0;
  font-size:18px;
}

/* 조이스틱 */
#joy{
  position:fixed;
  left:0; bottom:0;
  width:50vw; height:100vh;
}
#stick{
  position:absolute;
  left:80px; bottom:80px;
  width:80px; height:80px;
  border-radius:50%;
  background:rgba(255,255,255,.15);
}
#knob{
  position:absolute;
  left:20px; top:20px;
  width:40px; height:40px;
  border-radius:50%;
  background:white;
}
</style>
</head>

<body>
<div id="crosshair">✕</div>
<div id="hit"></div>
<div id="money">$0</div>

<div id="joy">
  <div id="stick">
    <div id="knob"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>
<script>
/* ======================
   THREE 기본 세팅
====================== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const camera = new THREE.PerspectiveCamera(
  75, innerWidth/innerHeight, 0.1, 1000
);
camera.position.set(0,2,5);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

window.addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

/* 빛 */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
const dl = new THREE.DirectionalLight(0xffffff,0.6);
dl.position.set(5,10,5);
scene.add(dl);

/* 바닥 */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x333333})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ======================
   플레이어
====================== */
const player = new THREE.Object3D();
player.position.set(0,0,0);
scene.add(player);

let playerHP = 100;
let money = 0;

/* ======================
   조이스틱 (왼쪽 전용)
====================== */
let moveX=0, moveY=0;
const stick = document.getElementById("stick");
const knob = document.getElementById("knob");

stick.addEventListener("touchstart",e=>{
  e.preventDefault();
});
stick.addEventListener("touchmove",e=>{
  e.preventDefault();
  const t = e.touches[0];
  const r = stick.getBoundingClientRect();
  const dx = t.clientX - (r.left+r.width/2);
  const dy = t.clientY - (r.top+r.height/2);
  const len = Math.min(40, Math.hypot(dx,dy));
  const ang = Math.atan2(dy,dx);
  const x = Math.cos(ang)*len;
  const y = Math.sin(ang)*len;
  knob.style.transform = `translate(${x}px,${y}px)`;
  moveX = x/40;
  moveY = y/40;
});
stick.addEventListener("touchend",()=>{
  knob.style.transform="translate(0,0)";
  moveX=moveY=0;
});

/* ======================
   시점 드래그 (오른쪽)
====================== */
let yaw=0, pitch=0;
let dragging=false;

window.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX > innerWidth/2) dragging=true;
});
window.addEventListener("touchmove",e=>{
  if(!dragging) return;
  const t = e.touches[0];
  yaw -= t.movementX*0.003;
  pitch -= t.movementY*0.003;
  pitch = Math.max(-1.2, Math.min(1.2,pitch));
});
window.addEventListener("touchend",()=>dragging=false);

/* ======================
   총 / 레이캐스트
====================== */
const raycaster = new THREE.Raycaster();
const weapons = {
  revolver:{damage:30},
};
let currentWeapon="revolver";

/* ======================
   적 AI
====================== */
const enemies=[];

function createEnemy(x,z){
  const e = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xaa3333});

  const body = new THREE.Mesh(
    new THREE.BoxGeometry(1,2,1), mat
  );
  body.position.y=1;
  e.add(body);

  e.position.set(x,0,z);
  e.hp=100;
  e.state="idle";
  e.cool=0;
  scene.add(e);
  enemies.push(e);
}

createEnemy(0,-20);
createEnemy(6,-25);
createEnemy(-6,-30);

function updateEnemy(e){
  if(e.state==="dead") return;
  const d = e.position.distanceTo(player.position);
  if(d>25) e.state="idle";
  else if(d>10) e.state="chase";
  else e.state="attack";

  if(e.state==="chase"){
    const dir = new THREE.Vector3()
      .subVectors(player.position,e.position)
      .normalize();
    e.position.add(dir.multiplyScalar(0.03));
  }

  if(e.state==="attack" && e.cool<=0){
    e.cool=60;
    playerHP-=10;
    document.getElementById("hit").style.opacity=1;
    setTimeout(()=>hit.style.opacity=0,100);
    if(playerHP<=0) respawn();
  }
  if(e.cool>0) e.cool--;
}

function killEnemy(e){
  e.state="dead";
  scene.remove(e);
  const r = Math.floor(Math.random()*10)+1;
  money+=r;
  document.getElementById("money").innerText="$"+money;
  setTimeout(()=>{
    e.hp=100;
    e.state="idle";
    e.position.set(
      (Math.random()-0.5)*20,
      0,
      -20-Math.random()*20
    );
    scene.add(e);
  },3000);
}

/* ======================
   발사
====================== */
window.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX < innerWidth/2) return;
  shoot();
});

function shoot(){
  raycaster.setFromCamera({x:0,y:0},camera);
  const objs = enemies.flatMap(e=>e.children);
  const hits = raycaster.intersectObjects(objs);
  if(hits.length){
    const mesh = hits[0].object;
    const enemy = enemies.find(e=>e.children.includes(mesh));
    enemy.hp -= weapons[currentWeapon].damage;
    mesh.material.color.set(0xffffff);
    setTimeout(()=>mesh.material.color.set(0xaa3333),80);
    if(enemy.hp<=0) killEnemy(enemy);
  }
}

/* ======================
   리스폰
====================== */
function respawn(){
  playerHP=100;
  player.position.set(0,0,0);
}

/* ======================
   루프
====================== */
function animate(){
  requestAnimationFrame(animate);

  // 이동
  const forward = new THREE.Vector3(
    Math.sin(yaw),0,Math.cos(yaw)
  );
  const right = new THREE.Vector3(
    Math.sin(yaw+Math.PI/2),0,
    Math.cos(yaw+Math.PI/2)
  );
  player.position.add(
    forward.multiplyScalar(-moveY*0.1)
  );
  player.position.add(
    right.multiplyScalar(moveX*0.1)
  );

  camera.position.copy(player.position);
  camera.position.y+=2;
  camera.rotation.set(pitch,yaw,0);

  enemies.forEach(updateEnemy);

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>