<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Western PvP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;overflow:hidden;background:#000;font-family:sans-serif}
#overlay{
  position:fixed;inset:0;
  background:#2b1d0e;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.skin{
  margin:10px;
  padding:12px 20px;
  border-radius:8px;
  background:#0008;
  border:2px solid #fff3;
  font-size:18px;
}
#ui{position:fixed;z-index:10}
#hp,#ammo{
  background:rgba(0,0,0,.5);
  color:white;padding:6px 10px;
  border-radius:6px;margin:5px;
}
#minimap{
  position:fixed;top:20px;right:20px;
  width:150px;height:150px;
  border-radius:50%;
  background:rgba(0,0,0,.4);
}
#joystick{
  position:fixed;left:20px;bottom:20px;
  width:120px;height:120px;
  background:rgba(255,255,255,.15);
  border-radius:50%;
}
#stick{
  position:absolute;left:35px;top:35px;
  width:50px;height:50px;
  background:white;border-radius:50%;
}
button{
  position:fixed;right:20px;
  padding:10px;border:none;
  border-radius:8px;font-size:18px;
}
#shoot{bottom:20px}
#view{bottom:80px}
#jump{bottom:140px}
#dash{bottom:200px}
</style>
</head>
<body>

<!-- ===== ìŠ¤í‚¨ ì„ íƒ ===== -->
<div id="overlay">
  <h1>ğŸ¤  ì¹´ìš°ë³´ì´ ì„ íƒ</h1>
  <button class="skin" onclick="selectSkin(0)">ë¸Œë¼ìš´ ì¹´ìš°ë³´ì´</button>
  <button class="skin" onclick="selectSkin(1)">ë¸”ë£¨ ì…°ë¦¬í”„</button>
  <button class="skin" onclick="selectSkin(2)">ë ˆë“œ ì•„ì›ƒë¡œ</button>
</div>

<div id="ui">
  <div id="hp">â¤ï¸ 100</div>
  <div id="ammo">ğŸ”« 6 / 6</div>
</div>

<canvas id="minimap" width="150" height="150"></canvas>
<div id="joystick"><div id="stick"></div></div>

<button id="shoot">ğŸ”«</button>
<button id="view">ğŸ‘ï¸</button>
<button id="jump">â¬†ï¸</button>
<button id="dash">ğŸ’¨</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===== Firebase ===== */
const firebaseConfig={
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  databaseURL:"YOUR_DB_URL",
  projectId:"YOUR_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ===== Skin ===== */
const skins=[
  {body:0x8b5a2b,hat:0x3b2a1a},
  {body:0x2d6cdf,hat:0x1e3a5f},
  {body:0xb02a2a,hat:0x4a0f0f}
];
let skinId=0;

function selectSkin(id){
  skinId=id;
  document.getElementById("overlay").style.display="none";
  startGame();
}

/* ===== Game ===== */
function startGame(){
const roomId=prompt("ë°© ì´ë¦„ ì…ë ¥");
const myId="p"+Math.random().toString(36).substr(2,5);

/* THREE */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0xcfa46a);
scene.fog=new THREE.Fog(0xcfa46a,20,120);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,300);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffe6c1,.4));
const sun=new THREE.DirectionalLight(0xffc27d,1.2);
sun.position.set(30,50,20);
scene.add(sun);

const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshStandardMaterial({color:0xc2a46d})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

/* Player */
function createPlayer(s){
  const g=new THREE.Group();
  const body=new THREE.Mesh(
    new THREE.BoxGeometry(1.2,1.5,0.7),
    new THREE.MeshStandardMaterial({color:s.body})
  );
  body.position.y=1.75; g.add(body);

  const head=new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({color:0xffdbac})
  );
  head.position.y=2.9; g.add(head);

  const hat=new THREE.Mesh(
    new THREE.CylinderGeometry(0.7,0.7,0.3,8),
    new THREE.MeshStandardMaterial({color:s.hat})
  );
  hat.position.y=3.4; g.add(hat);

  return g;
}

const player=createPlayer(skins[skinId]);
scene.add(player);

const enemies={};

/* UI */
let hp=100,ammo=6;
const hpUI=document.getElementById("hp");
const ammoUI=document.getElementById("ammo");
function updateUI(){
  hpUI.innerText=`â¤ï¸ ${hp}`;
  ammoUI.innerText=`ğŸ”« ${ammo} / 6`;
}

/* Movement */
let dx=0,dz=0,vy=0,grounded=true;
let yaw=0,pitch=0,drag=false,lx=0,ly=0;
let view="third";

/* Joystick */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
joy.addEventListener("touchmove",e=>{
  const r=40,rect=joy.getBoundingClientRect();
  let x=e.touches[0].clientX-(rect.left+60);
  let y=e.touches[0].clientY-(rect.top+60);
  const d=Math.hypot(x,y); if(d>r){x*=r/d;y*=r/d;}
  stick.style.left=35+x+"px"; stick.style.top=35+y+"px";
  dx=x*0.04; dz=y*0.04;
});
joy.addEventListener("touchend",()=>{dx=dz=0;stick.style.left="35px";stick.style.top="35px";});

/* Camera drag (right side only) */
addEventListener("touchstart",e=>{
  const x=e.touches[0].clientX;
  if(x<innerWidth/2)return;
  drag=true; lx=x; ly=e.touches[0].clientY;
});
addEventListener("touchmove",e=>{
  if(!drag)return;
  yaw-=(e.touches[0].clientX-lx)*0.005;
  pitch-=(e.touches[0].clientY-ly)*0.005;
  pitch=Math.max(-1.2,Math.min(1.2,pitch));
  lx=e.touches[0].clientX;
  ly=e.touches[0].clientY;
});
addEventListener("touchend",()=>drag=false);

/* Buttons */
shoot.onclick=()=>{
  if(ammo<=0)return;
  ammo--;updateUI();
  db.ref(`rooms/${roomId}/shots`).push({
    x:player.position.x,
    z:player.position.z,
    id:myId
  });
};
view.onclick=()=>view=view==="first"?"third":"first";
jump.onclick=()=>{if(grounded){vy=0.35;grounded=false;}};
dash.onclick=()=>{
  player.position.x+=Math.sin(yaw)*3;
  player.position.z+=Math.cos(yaw)*3;
};

/* PvP */
db.ref(`rooms/${roomId}/players`).on("value",snap=>{
  const d=snap.val()||{};
  for(const id in d){
    if(id===myId)continue;
    if(!enemies[id]){
      enemies[id]=createPlayer(skins[d[id].skin]);
      scene.add(enemies[id]);
    }
    enemies[id].position.set(d[id].x,0,d[id].z);
  }
});

/* Minimap */
const mini=document.getElementById("minimap");
const mctx=mini.getContext("2d");

/* Loop */
function animate(){
  requestAnimationFrame(animate);

  player.position.x+=dx;
  player.position.z+=dz;

  vy-=0.02;
  player.position.y+=vy;
  if(player.position.y<=0){
    player.position.y=0;vy=0;grounded=true;
  }

  if(view==="first"){
    camera.position.set(player.position.x,player.position.y+2.6,player.position.z);
  }else{
    camera.position.set(
      player.position.x+Math.sin(yaw)*6,
      player.position.y+4,
      player.position.z+Math.cos(yaw)*6
    );
  }
  camera.lookAt(player.position.x,player.position.y+2,player.position.z);

  db.ref(`rooms/${roomId}/players/${myId}`).set({
    x:player.position.x,
    z:player.position.z,
    skin:skinId
  });

  mctx.clearRect(0,0,150,150);
  mctx.fillStyle="cyan";
  mctx.beginPath();mctx.arc(75,75,5,0,Math.PI*2);mctx.fill();
  mctx.fillStyle="red";
  for(const id in enemies){
    const e=enemies[id];
    mctx.beginPath();
    mctx.arc(
      75+(e.position.x-player.position.x)*3,
      75+(e.position.z-player.position.z)*3,
      4,0,Math.PI*2
    );
    mctx.fill();
  }

  renderer.render(scene,camera);
}
animate();
}
</script>
</body>
</html>