<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<title>Mobile Roblox R6 Shooter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;overflow:hidden;background:#000;font-family:sans-serif}

/* ===== UI ===== */
#ui button{
  position:fixed;right:20px;
  padding:12px 16px;font-size:16px;
  border:none;border-radius:12px;
  background:#fff;z-index:10
}
#shoot{bottom:20px}
#aim{bottom:80px}
#view{bottom:140px}
#jump{bottom:200px}
#shopBtn{top:20px}

/* ===== ì¡°ì´ìŠ¤í‹± ===== */
#joyBase{
  position:fixed;left:30px;bottom:30px;
  width:120px;height:120px;border-radius:50%;
  background:rgba(255,255,255,.15);z-index:10
}
#joyStick{
  position:absolute;left:40px;top:40px;
  width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.6)
}

/* ===== ìƒì  ===== */
#shop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  display:none;flex-direction:column;
  align-items:center;justify-content:center;
  color:white;z-index:20
}
.shopItem{
  padding:10px 20px;margin:10px;
  border:1px solid white;border-radius:10px;
  cursor:pointer;
}

/* ===== HUD ===== */
#hud{
  position:fixed;top:10px;left:10px;
  color:white;font-weight:bold;
  z-index:10
}
#hud div{
  margin-bottom:6px;
  background:rgba(0,0,0,.5);
  padding:6px 10px;
  border-radius:8px
}
#weaponText{
  position:fixed;
  bottom:20px;left:50%;
  transform:translateX(-50%);
}
#moneyPopup{
  position:fixed;
  top:60px; left:50%;
  transform:translateX(-50%);
  font-size:24px;font-weight:bold;
  color:#0f0; opacity:0;
  transition:0.4s; z-index:20;
}
</style>
</head>
<body>

<div id="joyBase"><div id="joyStick"></div></div>

<div id="ui">
  <button id="shopBtn">ğŸ›’</button>
  <button id="view">ğŸ‘</button>
  <button id="aim">ğŸ¯</button>
  <button id="shoot">ğŸ”«</button>
  <button id="jump">â¬†ï¸</button>
</div>

<div id="shop">
  <h2>ì¹´ìš°ë³´ì´ ìƒì </h2>
  <div class="shopItem" onclick="buyWeapon('revolver')">ğŸ”« Revolver â€“ ë¬´ë£Œ</div>
  <div class="shopItem" onclick="buyWeapon('glock')">ğŸ”« Glock â€“ 2000$</div>
  <button onclick="closeShop()">ë‹«ê¸°</button>
</div>

<div id="hud">
  <div id="hpText">â¤ï¸ 100</div>
  <div id="coinText">$0</div>
  <div id="weaponText">ğŸ”« Revolver</div>
</div>

<div id="moneyPopup"></div>

<!-- ì‚¬ìš´ë“œ -->
<audio id="revolverSound" src="https://cdn.jsdelivr.net/gh/naptha/talkbox/sounds/gunshot.wav"></audio>
<audio id="glockSound" src="https://cdn.jsdelivr.net/gh/naptha/talkbox/sounds/laser.wav"></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script>
/* ===== ì €ì¥ ===== */
let skin = localStorage.getItem("skin") || "brown";
let money = Number(localStorage.getItem("money")) || 0;
let ownedWeapons = JSON.parse(localStorage.getItem("weapons")) || ["revolver"];

/* ===== THREE ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xcfa46a);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 300);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,.7));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(30,50,20);scene.add(sun);

/* ë°”ë‹¥ */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshStandardMaterial({color:0xc2a46d})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

/* ===== í”Œë ˆì´ì–´ (R6 ë¹„ìœ¨) ===== */
const player = new THREE.Group();scene.add(player);
const skinColor=()=> skin==="black"?0x222222:0xffdbac;

/* ëª¸í†µ */
const torso = new THREE.Mesh(
  new THREE.BoxGeometry(2,2,1),
  new THREE.MeshStandardMaterial({color:skinColor()})
);
torso.position.y=2;player.add(torso);

/* ë¨¸ë¦¬ */
const head = new THREE.Mesh(
  new THREE.BoxGeometry(1,1,1),
  new THREE.MeshStandardMaterial({color:skinColor()})
);
head.position.y=3.3;player.add(head);

/* ì˜¤ë¥¸íŒ” */
const rightArm = new THREE.Mesh(
  new THREE.BoxGeometry(1,2,1),
  new THREE.MeshStandardMaterial({color:skinColor()})
);
rightArm.position.set(1.5,2,0);player.add(rightArm);

/* ===== ì–¼êµ´(1:1:1) + CanvasTexture ===== */
const faceCanvas = document.createElement("canvas");
faceCanvas.width = 128; faceCanvas.height = 128;
const fctx = faceCanvas.getContext("2d");
const faceTex = new THREE.CanvasTexture(faceCanvas);

const face = new THREE.Mesh(
  new THREE.PlaneGeometry(0.9,0.9),
  new THREE.MeshBasicMaterial({map:faceTex,transparent:true})
);
face.position.z = 0.51;
head.add(face);

function drawFace(type="normal"){
  fctx.clearRect(0,0,128,128);
  fctx.fillStyle="#000";

  // ëˆˆ
  if(type==="dead"){
    fctx.strokeStyle="#000"; fctx.lineWidth=6;
    fctx.beginPath();
    fctx.moveTo(35,35); fctx.lineTo(55,55);
    fctx.moveTo(55,35); fctx.lineTo(35,55);
    fctx.moveTo(75,35); fctx.lineTo(95,55);
    fctx.moveTo(95,35); fctx.lineTo(75,55);
    fctx.stroke();
  }else{
    fctx.fillRect(40,40,12,12);
    fctx.fillRect(76,40,12,12);
  }

  // ì…
  fctx.lineWidth=6; fctx.beginPath();
  if(type==="angry"){fctx.arc(64,85,18,Math.PI,0,true);}
  else if(type==="aim"){fctx.moveTo(44,80); fctx.lineTo(84,80);}
  else if(type==="dead"){fctx.moveTo(44,88); fctx.lineTo(84,88);}
  else{fctx.arc(64,80,18,0,Math.PI);}
  fctx.stroke(); faceTex.needsUpdate = true;
}
drawFace();

/* ===== ë¬´ê¸° ===== */
const weapons = {
  revolver:{name:"Revolver",damage:25,recoil:0.15,fireRate:500,sound:"revolver"},
  glock:{name:"Glock",damage:15,recoil:0.07,fireRate:120,sound:"glock",price:2000},
  bbgun:{name:"BBgun",damage:5,recoil:0.02,fireRate:30,sound:"glock",price:100}
};
let currentWeapon="revolver";
let lastShot=0;
let gun;

function createRevolver(){
  const g=new THREE.Mesh(
    new THREE.BoxGeometry(1,0.3,0.3),
    new THREE.MeshStandardMaterial({color:0x222})
  );
  g.position.set(0,-1,0.8);
  return g;
}

function createGlock(){
  const g=new THREE.Group();
  const body=new THREE.Mesh(
    new THREE.BoxGeometry(0.9,0.25,0.3),
    new THREE.MeshStandardMaterial({color:0x111})
  ); g.add(body);
  const grip=new THREE.Mesh(
    new THREE.BoxGeometry(0.25,0.5,0.25),
    new THREE.MeshStandardMaterial({color:0x111})
  ); grip.position.set(-0.2,-0.4,0); g.add(grip);
  g.position.set(0,-1,0.8); return g;
}

function createBBgun(){
  const g=new THREE.Group();
  const body=new THREE.Mesh(
    new THREE.BoxGeometry(1,0.2,0.2),
    new THREE.MeshStandardMaterial({color:0x888})
  ); g.add(body);
  g.position.set(0,-1,0.8); return g;
}

function equipWeapon(type){
  if(gun) rightArm.remove(gun);
  if(type==="glock") gun=createGlock();
  else if(type==="bbgun") gun=createBBgun();
  else gun=createRevolver();
  rightArm.add(gun); currentWeapon=type; updateHUD();
}

/* ===== ì‚¬ìš´ë“œ ===== */
const sounds = {
  revolver: document.getElementById("revolverSound"),
  glock: document.getElementById("glockSound")
};
function playWeaponSound(){ const s=sounds[weapons[currentWeapon].sound]; s.currentTime=0; s.play(); }

/* ===== HUD ===== */
function updateHUD(){ 
  document.getElementById("weaponText").innerText=`ğŸ”« ${weapons[currentWeapon].name}`;
  document.getElementById("coinText").innerText=`$${money}`;
}

/* ===== ëˆ íŒì—… ===== */
function showMoneyPopup(amount){
  const el=document.getElementById("moneyPopup");
  if(amount>=0){el.innerText=`+$${amount}`;el.style.color="#0f0";}
  else{el.innerText=`-$${Math.abs(amount)}`;el.style.color="#f00";}
  el.style.opacity=1;
  setTimeout(()=>el.style.opacity=0,800);
}

/* ===== ìƒì  ===== */
function buyWeapon(type){
  const w=weapons[type];
  if(ownedWeapons.includes(type)){equipWeapon(type); closeShop(); return;}
  if(money<w.price){alert("ëˆ ë¶€ì¡±!"); return;}
  money-=w.price; localStorage.setItem("money",money); showMoneyPopup(-w.price);
  ownedWeapons.push(type); localStorage.setItem("weapons",JSON.stringify(ownedWeapons));
  equipWeapon(type); closeShop(); updateHUD();
}

function openShop(){
  const shopEl = document.getElementById("shop");
  shopEl.style.display="flex";

  // 1/100 í™•ë¥ ë¡œ BBgun ë“±ì¥
  if(Math.random()<0.01){
    if(!document.getElementById("bbgunItem")){
      const bb=document.createElement("div");
      bb.id="bbgunItem";
      bb.className="shopItem";
      bb.innerText="ğŸ”« BBgun â€“ 100$ (í’€ì˜¤í† )";
      bb.onclick=()=>buyWeapon("bbgun");
      shopEl.appendChild(bb);
    }
  }
}
function closeShop(){document.getElementById("shop").style.display="none";}
document.getElementById("shopBtn").onclick=openShop;

/* ===== ìƒíƒœ ===== */
let yaw=0,thirdPerson=true,aiming=false,jumping=false,jumpVel=0;
let hp=100,hitCount=0;
let recoil=0;

/* ===== Raycaster ===== */
const raycaster=new THREE.Raycaster();
const shootDir=new THREE.Vector3();

/* ===== ì¡°ì´ìŠ¤í‹± ===== */
let moveTouch=null,lookTouch=null;
let joyCenter={x:0,y:0},moveX=0,moveZ=0,lastLookX=0;

document.addEventListener("touchstart",e=>{
  for(const t of e.changedTouches){
    if(t.clientX<innerWidth/2 && moveTouch===null){moveTouch=t.identifier; joyCenter={x:t.clientX,y:t.clientY};}
    else if(t.clientX>=innerWidth/2 && lookTouch===null){lookTouch=t.identifier; lastLookX=t.clientX;}
  }
},{passive:false});
document.addEventListener("touchmove",e=>{
  for(const t of e.touches){
    if(t.identifier===moveTouch){
      const dx=t.clientX-joyCenter.x,dy=t.clientY-joyCenter.y;
      const dist=Math.min(40,Math.hypot(dx,dy)),ang=Math.atan2(dy,dx);
      moveX=Math.cos(ang)*(dist/40)*0.15; moveZ=Math.sin(ang)*(dist/40)*0.15;
    }
    if(t.identifier===lookTouch){
      const dx=t.clientX-lastLookX; lastLookX=t.clientX;
      yaw-=dx*0.004;
    }
  }
},{passive:false});
document.addEventListener("touchend",e=>{
  for(const t of e.changedTouches){
    if(t.identifier===moveTouch){moveTouch=null; moveX=0; moveZ=0;}
    if(t.identifier===lookTouch){lookTouch=null;}
  }
});

/* ===== ë²„íŠ¼ ===== */
document.getElementById("view").onclick=()=>thirdPerson=!thirdPerson;
document.getElementById("aim").onclick=()=>{
  aiming=!aiming; drawFace(aiming?"aim":"normal");
};
document.getElementById("jump").onclick=()=>{
  if(!jumping){jumping=true; jumpVel=0.35; rightArm.rotation.x=-0.5;}
};

/* ===== ì´/í”¼ê²©/ë³´ìƒ ===== */
function spawnShell(){
  const shell=new THREE.Mesh(
    new THREE.BoxGeometry(0.1,0.1,0.2),
    new THREE.MeshStandardMaterial({color:0xd4af37})
  ); gun.getWorldPosition(shell.position); scene.add(shell);
  let vx=(Math.random()-0.5)*0.2,vy=0.2,vz=(Math.random()-0.5)*0.2,life=30;
  function updateShell(){ if(life--<=0){scene.remove(shell);return;}
    vy-=0.02;shell.position.x+=vx;shell.position.y+=vy;shell.position.z+=vz;
    shell.rotation.x+=0.2;shell.rotation.y+=0.3; requestAnimationFrame(updateShell);}
  updateShell();
}

function shoot(){
  const now=Date.now(); const w=weapons[currentWeapon];
  if(now-lastShot<w.fireRate) return; lastShot=now;

  playWeaponSound(); recoil=w.recoil; spawnShell();

  camera.getWorldDirection(shootDir);
  raycaster.set(camera.position,shootDir);
  const hits=raycaster.intersectObjects([player],true);
  if(hits.length>0){hitCount++; takeDamage(w.damage);}
  updateHUD();
}

function takeDamage(dmg){
  hp-=dmg; if(hp<0) hp=0;
  drawFace("angry"); setTimeout(()=>drawFace("normal"),200);

  if(hp===0){
    drawFace("dead"); player.visible=false;
    giveKillReward(); hitCount=0;
  }
  updateHUD();
}

function giveKillReward(){
  let reward=Math.max(1,11-hitCount); money+=reward;
  localStorage.setItem("money",money);
  showMoneyPopup(reward);
}

/* ===== ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ ===== */
function animate(){
  requestAnimationFrame(animate);

  player.position.x+=moveX*Math.cos(yaw)-moveZ*Math.sin(yaw);
  player.position.z+=moveZ*Math.cos(yaw)+moveX*Math.sin(yaw);

  if(jumping){player.position.y+=jumpVel;jumpVel-=0.03;
    if(player.position.y<=0){player.position.y=0;jumping=false; rightArm.rotation.x=0;}}

  if(recoil>0){rightArm.rotation.x=-0.8; camera.rotation.x-=recoil; recoil-=0.03;}
  else rightArm.rotation.x*=0.8;

  const dist=thirdPerson?(aiming?4:8):0.1;
  camera.position.set(
    player.position.x+Math.sin(yaw)*dist,
    3,
    player.position.z+Math.cos(yaw)*dist
  );
  camera.lookAt(player.position.x,2,player.position.z);

  renderer.render(scene,camera);
}
animate();

/* ===== ì´ˆê¸° ì¥ì°© ===== */
equipWeapon("revolver");
updateHUD();
</script>
</body>
</html>